name: Cypress
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  e2e-and-ct:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Remove any npmrc
        run: |
          rm -f ~/.npmrc
          rm -f .npmrc
          
      - name: Show npm config
        run: |
          npm config list
          npm config get registry

      - name: Install deps (public registry, no user config)
        run: |
          npm --userconfig=/dev/null ci --registry=https://registry.npmjs.org/

      # ---- E2E ----
      - name: Cypress E2E
        uses: cypress-io/github-action@v6
        with:
          start: npm run dev -- --host 0.0.0.0 --port 5173
          wait-on: http://127.0.0.1:5173
          wait-on-timeout: 60
          command: npm run test:e2e

      # ---- Component ----
      - name: Cypress CT
        uses: cypress-io/github-action@v6
        with:
          install: false
          command: npm run test:ct
